#!/usr/bin/env bash
set -euo pipefail

# If users add multiple `metahook` instances, we'll just store our `vars` in the same directory.
if [[ ! -v "BUILDKITE_METAHOOK_HOOKS_PATH" ]]; then
  export BUILDKITE_METAHOOK_HOOKS_PATH="$(mktemp -d)"
  env | sort | grep "BUILDKITE_PLUGIN_METAHOOK" | uniq >"${BUILDKITE_METAHOOK_HOOKS_PATH}/vars"
fi

if grep -E 'BUILDKITE_PLUGIN_METAHOOK_.+(\.BAT|\.CMD)=' "${BUILDKITE_METAHOOK_HOOKS_PATH}/vars"; then
  echo "Sorry, we had to remove Windows Batch file support in 0.4.0."
  echo "Please refer to https://github.com/improbable-eng/metahook-buildkite-plugin/tree/master/changelog.md#0.4.0"
  echo ""
  exit 1
fi

"${BASH_SOURCE%/*}/run-hook.sh" "$(basename "${BASH_SOURCE[0]}")"
